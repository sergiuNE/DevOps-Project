services:
  mariadb:
    image: bitnamilegacy/mariadb:10.6
    environment:
      - ALLOW_EMPTY_PASSWORD=no
      - MARIADB_ROOT_PASSWORD_FILE=/run/secrets/db_root_password
      - MARIADB_DATABASE=bitnami_moodle
      - MARIADB_USER=bn_moodle
      - MARIADB_PASSWORD_FILE=/run/secrets/db_password
    volumes:
      - mariadb_data:/bitnami/mariadb
    networks:
      - backend
    secrets:
      - db_root_password
      - db_password

  moodle:
    image: bitnamilegacy/moodle:4.4
    depends_on:
      - mariadb
    environment:
      - MOODLE_DATABASE_HOST=mariadb
      - MOODLE_DATABASE_PORT_NUMBER=3306
      - MOODLE_DATABASE_USER=bn_moodle
      - MOODLE_DATABASE_PASSWORD_FILE=/run/secrets/db_password
      - MOODLE_DATABASE_NAME=bitnami_moodle
      - ALLOW_EMPTY_PASSWORD=no
      - MOODLE_HOST=10.158.10.72
      - MOODLE_REVERSEPROXY=yes
      - MOODLE_SSLPROXY=yes
      - MOODLE_SKIP_BOOTSTRAP=no
    volumes:
      - moodle_data:/bitnami/moodle
      - moodledata_data:/bitnami/moodledata
    networks:
      - frontend
      - backend
    secrets:
      - db_password
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=doorlopende-projectopdracht-sergiune_frontend"
      - "traefik.http.routers.moodle.rule=Host(`10.158.10.72`)"
      - "traefik.http.routers.moodle.entrypoints=web"
      - "traefik.http.routers.moodle-secure.rule=Host(`10.158.10.72`)"
      - "traefik.http.routers.moodle-secure.entrypoints=websecure"
      - "traefik.http.routers.moodle.priority=1"
      - "traefik.http.routers.moodle-secure.priority=1"
      - "traefik.http.routers.moodle-secure.tls=true"
      - "traefik.http.services.moodle.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      - "traefik.http.routers.moodle.middlewares=redirect-to-https"

  ltitool:
    build:
      context: ./ltitool
      dockerfile: Dockerfile
    environment:
      - SESSION_SECRET_FILE=/run/secrets/session_secret
      - OAUTH_SECRET_FILE=/run/secrets/oauth_secret
    networks:
      - frontend
    secrets:
      - session_secret
      - oauth_secret
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=doorlopende-projectopdracht-sergiune_frontend"
      - "traefik.http.routers.lti.rule=Host(`10.158.10.72`) && PathPrefix(`/lti`)"
      - "traefik.http.routers.lti-secure.rule=Host(`10.158.10.72`) && PathPrefix(`/lti`)"
      - "traefik.http.routers.lti.entrypoints=web"
      - "traefik.http.routers.lti-secure.entrypoints=websecure"
      - "traefik.http.routers.lti.priority=50"
      - "traefik.http.routers.lti-secure.priority=50"
      - "traefik.http.routers.lti-secure.tls=true"
      - "traefik.http.services.lti.loadbalancer.server.port=5000"
      - "traefik.http.middlewares.lti-stripprefix.stripprefix.prefixes=/lti"
      - "traefik.http.routers.lti.middlewares=lti-stripprefix"
      - "traefik.http.routers.lti-secure.middlewares=lti-stripprefix"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      - "traefik.http.routers.moodle.middlewares=redirect-to-https"

  traefik:
    image: traefik:v2.11
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--metrics.prometheus=true"
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/traefik/certs:ro
      - ./traefik-config.yml:/etc/traefik/dynamic/traefik-config.yml:ro
    networks:
      - frontend

  jenkins:
    image: jenkins/jenkins:lts
    restart: unless-stopped
    user: root
    volumes:
      - jenkins_data:/var/jenkins_home
    networks:
      - frontend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=doorlopende-projectopdracht-sergiune_frontend"
      - "traefik.http.routers.jenkins.rule=Host(`10.158.10.72`) && PathPrefix(`/jenkins`)"
      - "traefik.http.routers.jenkins.entrypoints=web"
      - "traefik.http.routers.jenkins.priority=100"
      - "traefik.http.services.jenkins.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.jenkins-headers.headers.customrequestheaders.X-Forwarded-Proto=http"
      - "traefik.http.middlewares.jenkins-prefix.addprefix.prefix=/jenkins"
      - "traefik.http.routers.jenkins.middlewares=jenkins-headers"
    environment:
      - JENKINS_OPTS=--prefix=/jenkins

volumes:
  moodle_data:
   driver: local
  moodledata_data:
   driver: local
  mariadb_data:
   driver: local
  jenkins_data:
   driver: local

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true

secrets:
  db_root_password:
    file: ./secrets/db_root_password.txt
  db_password:
    file: ./secrets/db_password.txt
  session_secret:
    file: ./secrets/session_secret.txt
  oauth_secret:
    file: ./secrets/oauth_secret.txt